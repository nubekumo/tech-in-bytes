{% extends 'base.html' %}
{% load static %}

{% block page_css %}
<link rel="stylesheet" href="{% static 'css/pages/home.css' %}?v={{ STATIC_VERSION }}" />
<link rel="stylesheet" href="{% static 'css/pages/blog.css' %}?v={{ STATIC_VERSION }}" />
{% endblock %}

{% block title %}
  {% if current_tag %}
    {{ current_tag.name }} Posts - Tech Bloggers
  {% elif current_search %}
    Search Results for "{{ current_search }}" - Tech Bloggers
  {% else %}
    All Posts - Tech Bloggers
  {% endif %}
{% endblock %}

{% block content %}
  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-content">
      <h1>
        {% if current_tag %}
          {{ current_tag.name }} Posts
        {% elif current_search %}
          Search Results for "{{ current_search }}"
        {% else %}
          All Blog Posts
        {% endif %}
      </h1>
      <div class="search-container">
        <form action="{% url 'blog:post_list' %}" method="get" class="search-form-fa">
          <input 
            type="text" 
            name="q" 
            id="search-input"
            class="search-input-fa" 
            placeholder="Search posts..."
            value="{{ current_search }}"
            maxlength="100"
          >
          {% if current_category %}
            <input type="hidden" name="category" value="{{ current_category }}">
          {% endif %}
          <button type="submit" class="search-button-fa" id="search-button">
            <i class="fas fa-search" id="search-icon"></i>
          </button>
        </form>
      </div>
    </div>
  </section>

  <!-- Filter Section -->
  <section class="filter-section container">
    <div class="filter-wrapper">
      <i class="fas fa-filter"></i>
      <select class="filter-select" onchange="window.location.href=this.value">
        <option value="{% url 'blog:post_list' %}" {% if not current_category %}selected{% endif %}>All Posts</option>
        {% for available_tag in available_tags %}
          <option value="{% url 'blog:post_list' %}?category={{ available_tag.slug }}" {% if current_category == available_tag.slug %}selected{% endif %}>
            {{ available_tag.name }}
          </option>
        {% endfor %}
      </select>
    </div>
  </section>

  <!-- Posts Grid -->
  <section class="recommended container">
    {% if posts %}
      <div class="grid-recommended">
        {% for post in posts %}
          <article class="card recom-card">
            <a href="{% url 'blog:post_detail' pk=post.id slug=post.slug %}">
              {% if post.image %}
              <img 
                src="{{ post.image.url }}" 
                alt="{{ post.title }}"
              >
              {% else %}
              <div class="default-post-image">
                <span class="logo-text">Tech Bloggers</span>
              </div>
              {% endif %}
              <div class="card-body">
                <h4>{{ post.title }}</h4>
                <div class="meta">
                  <span><i class="fas fa-user"></i> {{ post.author.get_full_name|default:post.author.username }}</span>
                  <span><i class="fas fa-calendar"></i> {{ post.published_at|date:"M d, Y" }}</span>
                  <span><i class="fas fa-comments"></i> {{ post.top_level_comment_count }}</span>
                </div>
                <p>{{ post.content|striptags|truncatechars:140 }}</p>
                <div class="meta">
                  {% for tag in post.tags.all %}
                    <span class="category-tag">{{ tag.name }}</span>
                  {% endfor %}
                </div>
              </div>
            </a>
          </article>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% if is_paginated %}
        <div class="pagination">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if current_search %}&q={{ current_search }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}" class="page-link">&laquo; Previous</a>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <a href="?page={{ num }}{% if current_search %}&q={{ current_search }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}" class="page-link active">{{ num }}</a>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <a href="?page={{ num }}{% if current_search %}&q={{ current_search }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}" class="page-link">{{ num }}</a>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if current_search %}&q={{ current_search }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}" class="page-link">Next &raquo;</a>
          {% endif %}
        </div>
      {% endif %}
    {% else %}
      <div class="empty-state">
        <h3>No posts found.</h3>
        {% if current_tag and current_search %}
          <p>No posts found in "{{ current_tag.name }}" matching "{{ current_search }}".</p>
        {% elif current_tag %}
          <p>No posts found with the category "{{ current_tag.name }}".</p>
        {% elif current_search %}
          <p>No posts found matching "{{ current_search }}".</p>
        {% else %}
          <p>There are no posts available at the moment.</p>
        {% endif %}
      </div>
    {% endif %}
  </section>

  <!-- Back to Top Button -->
  <div class="go-to-all-btn-container">
    <a href="#" class="btn btn--primary" data-action="scroll-to-top">
      Back to Top
    </a>
  </div>
{% endblock %}
