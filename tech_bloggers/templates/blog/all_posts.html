{% extends 'base.html' %}
{% load static %}

{% block title %}
  {% if tag %}
    {{ tag.name }} Posts - Tech Bloggers
  {% elif filter == 'liked' %}
    Liked Posts - Tech Bloggers
  {% else %}
    All Posts - Tech Bloggers
  {% endif %}
{% endblock %}

{% block content %}
  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-content">
      <h1>
        {% if tag %}
          {{ tag.name }} Posts
        {% elif filter == 'liked' %}
          Your Liked Posts
        {% else %}
          All Blog Posts
        {% endif %}
      </h1>
      <div class="search-container">
        <form action="{% url 'blog:post_list' %}" method="get" class="search-form-fa">
          <input 
            type="text" 
            name="q" 
            class="search-input-fa" 
            placeholder="Search posts..."
            value="{{ request.GET.q|default:'' }}"
          >
          <button type="submit" class="search-button-fa">
            <i class="fas fa-search"></i>
          </button>
        </form>
      </div>
    </div>
  </section>

  <!-- Filter Section -->
  <section class="filter-section container">
    <div class="filter-wrapper">
      <i class="fas fa-filter"></i>
      <select class="filter-select" onchange="window.location.href=this.value">
        <option value="{% url 'blog:post_list' %}" {% if not tag and not filter %}selected{% endif %}>All Posts</option>
        <option value="{% url 'blog:post_list' %}?filter=liked" {% if filter == 'liked' %}selected{% endif %}>Liked Posts</option>
        {% for available_tag in available_tags %}
          <option value="{% url 'blog:tag_detail' available_tag.slug %}" {% if tag.id == available_tag.id %}selected{% endif %}>
            {{ available_tag.name }}
          </option>
        {% endfor %}
      </select>
    </div>
  </section>

  <!-- Posts Grid -->
  <section class="recommended container">
    {% if posts %}
      <div class="grid-recommended">
        {% for post in posts %}
          <article class="card recom-card">
            <a href="{% url 'blog:post_detail' pk=post.id slug=post.slug %}">
              <img 
                src="{{ post.image.url }}" 
                alt="{{ post.title }}" 
                onerror="this.src=`{% static 'images/default-post.jpg' %}`"
              >
              <div class="card-body">
                <h4>{{ post.title }}</h4>
                <div class="meta">
                  <span><i class="fas fa-user"></i> {{ post.author.get_full_name|default:post.author.username }}</span>
                  <span><i class="fas fa-calendar"></i> {{ post.published_at|date:"M d, Y" }}</span>
                  <span><i class="fas fa-comments"></i> {{ post.comments.count }}</span>
                </div>
                <p>{{ post.summary|truncatewords:20 }}</p>
                <div class="meta">
                  {% for tag in post.tags.all %}
                    <span class="category-tag">{{ tag.name }}</span>
                  {% endfor %}
                </div>
              </div>
            </a>
          </article>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% if is_paginated %}
        <div class="pagination">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="page-link">&laquo; Previous</a>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <a href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="page-link active">{{ num }}</a>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <a href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="page-link">{{ num }}</a>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="page-link">Next &raquo;</a>
          {% endif %}
        </div>
      {% endif %}
    {% else %}
      <div class="empty-state">
        <h3>No posts found.</h3>
        {% if filter == 'liked' %}
          <p>You haven't liked any posts yet.</p>
        {% elif tag %}
          <p>No posts found with the tag "{{ tag.name }}".</p>
        {% elif request.GET.q %}
          <p>No posts found matching "{{ request.GET.q }}".</p>
        {% else %}
          <p>There are no posts available at the moment.</p>
        {% endif %}
      </div>
    {% endif %}
  </section>

  <!-- Back to Top Button -->
  <div class="go-to-all-btn-container">
    <a href="#" class="btn btn--primary" onclick="window.scrollTo({top: 0, behavior: 'smooth'}); return false;">
      Back to Top
    </a>
  </div>
{% endblock %}
