{% extends "base.html" %} 
{% load static %} {% block title %}Account Settings - Tech Bloggers {% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{% static 'css/pages/auth.css' %}?v=4.0" />
{% endblock %}

{% block extra_head %}{% endblock %} {% block content %}

<div class="settings-container">
  <!-- Header -->
  <div class="settings-header">
    <h1>Account Settings</h1>
  </div>

  <!-- Tabs -->
  <div class="settings-tabs">
    <div class="settings-tab active" data-tab="profile">Profile</div>
    <div class="settings-tab" data-tab="account">Account</div>
    <div class="settings-tab" data-tab="security">Security</div>
    <div class="settings-tab" data-tab="danger">Danger Zone</div>
  </div>

  <!-- Content -->
  <div class="settings-content">
    <!-- Profile Tab -->
    <div class="tab-panel active" id="profile-panel">
      <form
        method="post"
        action="{% url 'accounts:update_profile' %}"
        enctype="multipart/form-data"
        id="profile-form"
      >
        {% csrf_token %}

        <!-- Avatar Upload -->
        <div class="avatar-upload">
          <div class="avatar-preview" id="avatar-upload-zone">
            {% if user.profile.avatar %}
            <img
              src="{{ user.profile.avatar.url }}"
              alt="Profile avatar"
              id="avatar-preview-img"
            />
            {% else %}
            <div class="avatar-placeholder" id="avatar-placeholder">
              Upload your Picture
            </div>
            {% endif %}
            <div class="avatar-overlay">
              <i class="fas fa-camera"></i>
              <span>Change Avatar</span>
            </div>
            {{ form.avatar }}
          </div>
          <div class="avatar-actions">
            <button type="button" class="btn btn--outline btn-sm" id="change-avatar-btn">
              <i class="fas fa-camera"></i> Change Avatar
            </button>
          </div>
          <p class="avatar-help-text">Drag image to reposition</p>
        </div>

        <!-- Bio -->
        <div class="form-group">
          <label for="id_bio">Bio</label>
          {{ form.bio }} {% if form.bio.errors %}
          <div class="form-feedback error">{{ form.bio.errors.0 }}</div>
          {% endif %}
        </div>

        <button type="submit" class="btn btn--primary">Save Profile</button>
      </form>
    </div>

    <!-- Account Tab -->
    <div class="tab-panel" id="account-panel">
      <!-- Email Update Section -->
      <div class="account-section">
        <h3>Email Address</h3>
        <form
          method="post"
          action="{% url 'accounts:update_email' %}"
          id="email-form"
        >
          {% csrf_token %}
          <div class="form-group">
            <label for="id_email">Email Address</label>
            {{ email_form.email }} {% if email_form.email.errors %}
            <div class="form-feedback error">{{ email_form.email.errors.0 }}</div>
            {% endif %}
          </div>

          <button type="submit" class="btn btn--primary">Update Email</button>
        </form>
      </div>

      <!-- Two-Factor Authentication Section -->
      <div class="account-section">
        <h3>Two-Factor Authentication</h3>
        <div class="two-factor-status">
          {% if has_2fa %}
            <div class="status-enabled">
              <i class="fas fa-shield-alt"></i>
              <span>Two-factor authentication is <strong>enabled</strong></span>
            </div>
            <div class="two-factor-actions">
              <a href="{% url 'accounts:two_factor_backup_tokens' %}" class="btn btn--secondary">
                <i class="fas fa-key"></i> View Backup Tokens
              </a>
              <button type="button" class="btn btn--danger" data-action="show-disable-2fa">
                <i class="fas fa-times"></i> Disable 2FA
              </button>
            </div>
          {% else %}
            <div class="status-disabled">
              <i class="fas fa-shield-alt"></i>
              <span>Two-factor authentication is <strong>disabled</strong></span>
            </div>
            <div class="two-factor-actions">
              <a href="{% url 'accounts:two_factor_setup' %}" class="btn btn--primary">
                <i class="fas fa-plus"></i> Enable 2FA
              </a>
            </div>
          {% endif %}
        </div>
        
        <div class="two-factor-info">
          <p>
            <i class="fas fa-info-circle"></i>
            Two-factor authentication adds an extra layer of security to your account by requiring a verification code from your authenticator app in addition to your password.
          </p>
        </div>
      </div>

      <!-- Disable 2FA Modal -->
      <div id="disable-2fa-modal" class="modal" style="display: none;">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Disable Two-Factor Authentication</h3>
            <button type="button" class="modal-close" data-action="hide-disable-2fa">&times;</button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to disable two-factor authentication? This will make your account less secure.</p>
            <form method="post" action="{% url 'accounts:two_factor_disable' %}">
              {% csrf_token %}
              <div class="form-group">
                <label for="disable_password">Enter your password to confirm:</label>
                <div class="password-field">
                  <input
                    type="password"
                    name="password"
                    id="disable_password"
                    class="form-control"
                    required
                  />
                  <button
                    type="button"
                    class="password-toggle"
                    data-target="disable_password"
                  >
                    <i class="far fa-eye"></i>
                  </button>
                </div>
              </div>
              <div class="modal-actions">
                <button type="button" class="btn btn--secondary" data-action="hide-disable-2fa">Cancel</button>
                <button type="submit" class="btn btn--danger">Disable 2FA</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Security Tab -->
    <div class="tab-panel" id="security-panel">
      <!-- Password Change Section -->
      <div class="security-section">
        <h3>Change Password</h3>
        <form
          method="post"
          action="{% url 'accounts:update_password' %}"
          id="password-form"
        >
          {% csrf_token %}

          <div class="form-group">
            <label for="old_password">Current Password</label>
            <div class="password-field">
              <input
                type="password"
                name="old_password"
                id="old_password"
                class="form-control"
                required
              />
              <button
                type="button"
                class="password-toggle"
                data-target="old_password"
              >
                <i class="far fa-eye"></i>
              </button>
            </div>
          </div>

          <div class="form-group">
            <label for="new_password1">New Password</label>
            <div class="password-field">
              <input
                type="password"
                name="new_password1"
                id="new_password1"
                class="form-control"
                required
              />
              <button
                type="button"
                class="password-toggle"
                data-target="new_password1"
              >
                <i class="far fa-eye"></i>
              </button>
            </div>

            <div class="password-requirements">
              <div class="requirement-item" data-requirement="length">
                <i class="fas fa-circle"></i>
                <span>At least 8 characters long</span>
              </div>
              <div class="requirement-item" data-requirement="uppercase">
                <i class="fas fa-circle"></i>
                <span>Contains uppercase letter</span>
              </div>
              <div class="requirement-item" data-requirement="lowercase">
                <i class="fas fa-circle"></i>
                <span>Contains lowercase letter</span>
              </div>
              <div class="requirement-item" data-requirement="number">
                <i class="fas fa-circle"></i>
                <span>Contains number</span>
              </div>
              <div class="requirement-item" data-requirement="special">
                <i class="fas fa-circle"></i>
                <span>Contains special character</span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="new_password2">Confirm New Password</label>
            <div class="password-field">
              <input
                type="password"
                name="new_password2"
                id="new_password2"
                class="form-control"
                required
              />
              <button
                type="button"
                class="password-toggle"
                data-target="new_password2"
              >
                <i class="far fa-eye"></i>
              </button>
            </div>
          </div>

          <button type="submit" class="btn btn--primary">Change Password</button>
        </form>
      </div>
    </div>

    <!-- Danger Zone Tab -->
    <div class="tab-panel" id="danger-panel">
      <div class="danger-zone">
        <h3>Delete Account</h3>
        <p>
          Once you delete your account, there is no going back. Please be
          certain.
        </p>
        <div class="form-group">
          <a href="{% url 'accounts:delete_account' %}" class="btn btn--danger">
            <i class="fas fa-trash-alt"></i> Delete My Account
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
