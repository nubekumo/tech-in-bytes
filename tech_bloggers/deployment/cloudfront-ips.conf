#!/bin/bash
# Script to update /etc/nginx/cloudfront-ips.conf

AWS_IP_RANGES_URL="https://ip-ranges.amazonaws.com/ip-ranges.json"
OUTPUT_FILE="/etc/nginx/cloudfront-ips.conf"
TEMP_FILE="/tmp/cloudfront-ips.conf"

# Generate the config
{
  echo "# CloudFront IP ranges - Auto-generated on $(date)"
  echo "# Source: $AWS_IP_RANGES_URL"
  echo ""
  
  curl -s "$AWS_IP_RANGES_URL" | jq -r '
    (.prefixes[] | select(.service=="CLOUDFRONT") | "set_real_ip_from \(.ip_prefix);"),
    (.ipv6_prefixes[] | select(.service=="CLOUDFRONT") | "set_real_ip_from \(.ipv6_prefix);")
  '
  
  echo ""
  echo "real_ip_header X-Forwarded-For;"
  echo "real_ip_recursive on;"
} > "$TEMP_FILE"

# Test nginx config with the new file
sudo cp "$TEMP_FILE" "$OUTPUT_FILE"
sudo nginx -t && sudo systemctl reload nginx

echo "CloudFront IPs updated successfully!"